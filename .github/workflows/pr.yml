name: PR Check

on:
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    name: Code Qualityy & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Run Ruff (code style & errors)
        run: |
          echo "::group::Ruff Check"
          ruff check src/ --output-format=json > reports/ruff.json
          ruff check src/ --output-format=github
          echo "::endgroup::"
      
      - name: Run Mypy (type checking)
        run: |
          echo "::group::Mypy Type Check"
          mypy src/calctl \
            --html-report reports/mypy \
            --txt-report reports
          echo "::endgroup::"
      
      - name: Run Bandit (security scan)
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r src/calctl -f json -o reports/bandit.json
          bandit -r src/calctl -f html -o reports/bandit.html
          bandit -r src/calctl
          echo "::endgroup::"
      
      - name: Upload lint reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lint-reports
          path: reports/
          retention-days: 7

  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run tests with coverage
        run: |
          mkdir -p reports
          pytest tests/ -v \
            --cov=src/calctl \
            --cov-report=html:reports/coverage \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing \
            --junitxml=reports/junit.xml \
            --cov-fail-under=70
      
      - name: Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-reports
          path: reports/coverage/
          retention-days: 7
      
      - name: Upload test report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-report
          path: reports/junit.xml
          retention-days: 7
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./reports/coverage.xml
          flags: unittests
          name: codecov-pr
        continue-on-error: true

  docs:
    name: Documentation Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material
      
      - name: Build documentation
        run: |
          echo "::group::MkDocs Build"
          mkdocs build --strict --site-dir reports/docs
          echo "::endgroup::"
      
      - name: Verify docs build
        run: |
          test -f reports/docs/index.html || exit 1
          echo "✓ Documentation built successfully"
      
      - name: Upload docs
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: reports/docs/
          retention-days: 7
  
  quality-gate:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [lint, test, docs]
    if: always()
    
    steps:
      - name: Check quality gate status
        run: |
          echo "## Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "✅ Lint: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Lint: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docs.result }}" == "success" ]; then
            echo "✅ Docs: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Docs: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.docs.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Quality gate FAILED. Please fix the issues above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All quality checks passed!**" >> $GITHUB_STEP_SUMMARY
