name: Main Branch CI

on:
  push:
    branches: [main]

jobs:
  lint:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Run Ruff
        run: |
          ruff check src/ --output-format=json > reports/ruff.json
          ruff check src/
      
      - name: Run Mypy
        run: |
          mypy src/calctl --html-report reports/mypy --txt-report reports
      
      - name: Run Bandit
        run: |
          bandit -r src/calctl -f json -o reports/bandit.json
          bandit -r src/calctl -f html -o reports/bandit.html
      
      - name: Upload lint reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-reports
          path: reports/
          retention-days: 30

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run FULL test suite with coverage
        run: |
          mkdir -p reports
          pytest tests/ -v \
            --cov=src/calctl \
            --cov-report=html:reports/coverage \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing \
            --junitxml=reports/junit.xml \
            --cov-fail-under=80
      
      - name: Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report (Main Branch)" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold: 80%**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: reports/coverage/
          retention-days: 30
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./reports/coverage.xml
          flags: unittests
          name: codecov-main

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install build tools
        run: |
          pip install build
      
      - name: Build package
        run: |
          python -m build
      
      - name: Verify package
        run: |
          echo "::group::Check distribution"
          twine check dist/*
          echo "::endgroup::"
      
      - name: Test installation
        run: |
          echo "::group::Test wheel installation"
          python -m venv test-venv
          source test-venv/bin/activate
          pip install dist/*.whl
          calctl --version
          calctl --help
          deactivate
          echo "::endgroup::"
      
      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material
      
      - name: Build docs
        run: |
          mkdocs build --strict --site-dir reports/docs
      
      - name: Upload docs
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: reports/docs/
          retention-days: 30
      
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports/docs
  
  quality-gate:
    name: Quality Gate (Main)
    runs-on: ubuntu-latest
    needs: [lint, test, build, docs]
    if: always()
    
    steps:
      - name: Check all gates
        run: |
          echo "## Main Branch Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "✅ Static Analysis: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Static Analysis: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Test Suite (80% coverage): PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Test Suite: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ Package Build & Verify: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Package Build: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.docs.result }}" == "success" ]; then
            echo "✅ Documentation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Documentation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.docs.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **MAIN BRANCH NOT RELEASABLE**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Main branch is RELEASABLE**" >> $GITHUB_STEP_SUMMARY
          echo "Ready for production deployment" >> $GITHUB_STEP_SUMMARY